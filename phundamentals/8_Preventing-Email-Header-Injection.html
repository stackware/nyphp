<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-51353372-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-51353372-3');
</script>

    <script src="http://cdn.speedr.io/speeder.js"></script>
    <script>speeder('55730cc6','df9');</script>
    
    <meta name="verify-v1" content="zWMoPwMn/dolscLkjLXTpRqgr9K8bzlzL1vM9WTjpHc=" />
    <meta name="msvalidate.01" content="F85F81C1D0BAB5C349E8395628845E27" />
    <meta name="y_key" content="265502be3db4fb6e" />

    <link rel="icon" type="image/png" href="../img/favicon.png">

    <title>Preventing Email Header Injection - PHundamental PHP Best Practices -</title>

    <link href="../css/nyphp2.css" rel="stylesheet" media="screen" type="text/css" />
    <link href="../css/nyphp2_print.css" rel="stylesheet" media="print" type="text/css" />

    <meta name="robots" content="index,follow" />
    <meta name="description" content="Preventing Email Header Injection - PHP best practices and LAMP stack strategy." />
    <meta name="author" content="Stackware Web Development - http://stackware.com" />
</head>


<body>


<div id="GlobalContainer">

    <div id="Header">
        
<div class="HeaderContainer">
    <div class="HeaderLeft">
        <a href="../index.html"><img src="../img/new_york_php.gif" alt="New York PHP User Group Community" /></a>
    </div>
    <div class="HeaderRight">
        <h1><a href="http://stackware.com/nyc-php-training">PHP Training</a></h1>
    </div>
    <div class="HeaderFirstBar" style="padding: 0; margin: 0 0 0 -6px;">
    <ul>
        <li>
            <a  href="../index.html" title="Home">Home</a>
        </li>
        <li>
            <a  href="../mailing-lists.html" title="PHP Mailing Lists">Mailing Lists</a>
        </li>
        <li>
            <a style="text-decoration: underline;" href="../phunny/err_sample_include.php.html" title="PHundamentals">PHundamentals</a>
        </li>
        <li>
            <a  href="../php-presentations/index.html" title="Presentations">Presentations</a>
        </li>
        <li>
            <a href="../php-presentations/82_Online-PHP-Forums.html" title="NY PHP Meetup">Contact Us</a>
        </li>
    </ul>
    </div>

    <div class="HeaderSecondBar">
        <div style="margin: 11px 0 0 -4px; padding: 0;">
        <small>don't forget to</small>
        <a style="font-weight: bold;" href="https://www.facebook.com/groups/367255050049061/">facebook friend</a> -
        <a style="font-weight: bold;" href="http://twitter.com/nyphp">twitter follow</a> -
        <a style="font-weight: bold;" href="../php-presentations/82_Online-PHP-Forums.html">NYC PHP meetup</a>
        </div>
    </div>
</div>



    </div>

    <div id="MainLayout">
    <div id="TwoColumn">
        <div id="LeftColumn">
            
<div class="LeftNav">

    <div class="NowLinks">


        <div class="ShowParticipation">
        <a href="../show-participation.html">Show Your Participation
        <img style="margin: 2px;" alt="NYPHP Member" src="../img/nyphporgmember.gif" />
        Click for Details</a>
        </div>

        <div style="height: 15px;"></div>

    </div>

    <div style="height: 15px;"></div>

<div class="LeftNavSection">

    <div class="LeftNavSubSection">
        <a target="_blank" href="https://www.meetup.com/tampa-bay-php/">
            <img width="120px" src="../img/tbphp.gif" alt="Tampa Bay Florida PHP" title="Tampa Bay Florida PHP" />
        </a>
        <a target="_blank" title="Tampa Bay Florida PHP" href="http://www.tbphp.org/">
            Tampa Bay<br />Florida PHP
        </a>
    </div>


    <div class="LeftNavSubSection">
        <a href="http://www.flickr.com/groups/nyphp/">
        <img src="../img/flickr.logo.gif" alt="NYPHP flickr Group" title="New York PHP flickr Group" />
        </a>
        Browse and upload photos of events, at the
        <a href="http://www.flickr.com/groups/nyphp/">NYPHP flickr Group</a>.
    </div>
    <div class="LeftNavSubSection">
        <a href="http://www.linkedin.com/e/gis/110439">
        <img src="../img/linkedin.logo.gif" alt="PHP Community" title="New York PHP Community LinkedIn" />
        </a>
        Link up with NYPHP at the
        <a href="http://www.linkedin.com/groups?about=&amp;gid=110439">PHP LinkedIn Group</a>.
    </div>

</div>


<div class="BoxLinks" style="text-align: left;">
    <p class="BoxLinkHeader">About NYPHP</p>
    <p><a href="../about-us/charter.html">&raquo; Charter</a></p>
    <p><a href="../about-us/mission.html">&raquo; Mission</a></p>
    <p><a href="../about-us/index.html">&raquo; What is NYPHP?</a></p>
    <p><a href="../about-us/principals.html">&raquo; Principals</a></p>
    <p><a href="../about-us/sponsors.html">&raquo; Sponsors</a></p>
</div>


</div>

            <div class="SubLeftColumn">
            
<div class="Event">
<!--Last revision on Sept. 25, 2005-->
<h1>Email Header Injection Exploit</h1>
<h2>NYPHP - <span style="color: rgb(0, 0, 153);">PH</span>undamentals</h2>
<p>
A botnet is scanning the web to locate PHP scripts which are vulnerable to a email
header injection exploit. All PHP scripts which send email based on
input data, such as when a user supplies a &quot;From&quot; or a &quot;To&quot; address, may be vulnerable.
In addition, the botnet attempts to inject headers into any other fields it finds on a
form such as hidden fields.
<!--
All PHP scripts which use external data as any part of a constructed email
header, such as when a form accepts data that will populate a To:, From: or
Subject: header field, may be vulnerable.
-->
</p>

<h2>Discussion</h2>
<p>
A distributed network of machines is currently being
employed to scan PHP-based websites in search of scripts which might be
vulnerable to an injection-style security exploit. The exploit, if successful, permits
the botnet to send emails to arbitrary destinations. A common target of the botnet
is the kind of web-based feedback form which submits an email to a
user-provided designated address.
The botnet script injects malicious email
headers into the form's fields, which are then passed to the mail server.
The mail server parses those headers and then, if the attack was successful,
it sends an email to the
address designated in the maliciously injected headers. We assume the
attacker is collecting a list of vulnerable sites which may be used
later as an open relay for spam or large scale deployment of
viruses/worms.
</p>
<p>
As of this writing (September 2005), the source of this botnet has
been been traced to a number of different remote hosts such as the following:
	<pre>
	medres.cmdik.pan.pl (resolves to a website based in Poland)
	67.110.225.236.ptr.us.xo.net (resolves to XO Communications in the U.S.)
	</pre>
</p>
<p>
The botnet attempts to insert an email with its
own headers which, in turn, contains a BCC header. This BCC header has been found to contain one of the
email addresses in the list below (current as of this writing on September 2005). No doubt the receipt
of an email at any of these addresses must serve as an alert which lets the attacker know that a
vulnerable script has been found.
</p>
<ul>
	<li>jrubin3546@aol.com</li>
	<li>mkoch321@aol.com</li>
	<li>wnacyiplay@aol.com</li>
	<li>kshmng@aol.com</li>
	<li>homeiragtime@aol.com</li>
	<li>bergkoch8@aol.com</li>
</ul>
<p>
A Google search for the injected email addresses reveals that scans have been
taking place since at least July 8, 2005
</p>
<h2>Are My Scripts Vulnerable?</h2>
<p>If you have a PHP script that relies on user input for generating an email,
then your script is potentially vulnerable to this exploit.
</p>
<p>You can determine if you have <strong>already</strong> been a victim of the
email header injection exploit by examining your mail log or your access log for the
email addresses or remote host addresses listed above. <strong>Important</strong>:
The email and remote host lists are not exhaustive, and the botnet is likely to use
additional BCC email addresses and will likely &quot;originate&quot;
from many different remote hosts.
</p>
<p>To determine if you have already been a victim of this particular botnet, you can
grep through your mail server logs for the list of emails, using a
command something like this:
</p>
<pre>
grep -f exploitaddresses.lst /var/log/maillog
</pre>
<p> (or wherever your mail log is located)
</p>

<p>
If any are found, cross reference the time of the mailing to times in
your web server logs to help determine the exploitable script. Modify
any such scripts to properly filter input fields and any other fields that
may be used by your script to generate an email.
</p>
<p>
If you have grepped your access log you will immediately know the name of the
script that was accessed.
</p>
<p><strong>Important:</strong> The email and remote host addresses listed can be used as a
starting point to determine if you have already been a victim of this particular exploit.
However, keep in mind that the attacker can change them at any time and so searching for these
in your logs is <strong>not</strong> a solution for preventing future attacks. Your scripts
may <strong>STILL</strong> be vulnerable. Therefore you should review the code for any of your
scripts that rely on user input for constructing an email. In addition, you should examine any other
fields in your scripts that may <strong>NOT</strong> rely on user input but which are still used in the
generation of an email. Note the two error log snippets below.
</p>
<p> In Snippet No. 1, the botnet has tried to manipulate form variables, a hidden form variable ('_submit')
and other variables such as the session ID.
</p>
<pre>
Snippet 1:

array(53) {
  ["HOME"]=>
  string(1) "/"
  ["PATH"]=>
  string(29) "/sbin:/bin:/usr/sbin:/usr/bin"
  ["_submit"]=>
  string(29) "yrfockfsy@example.com"
  ["password"]=>
  string(29) "yrfockfsy@example.com"
  ["PHPSESSID"]=>
  string(445) "yrfockfsy@example.com
Content-Type: multipart/mixed; boundary=\"===============1678997057==\"
MIME-Version: 1.0
Subject: 8526bb87
To: yrfockfsy@example.com
bcc: Homeiragtime@aol.com
From: yrfockfsy@example.com

This is a multi-part message in MIME format.

--===============1678997057==
Content-Type: text/plain; charset=\"us-ascii\"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit

fvf
--===============1678997057==--
"
</pre>
<p> In Snippet No. 2, the botnet has <strong>again</strong> tried to manipulate form variables,
a hidden form variable ('_submit') and other variables such as the session ID but in this case,
the submitted values have been changed.
</p>
<pre>
Snippet 2:


array(53) {
  ["HOME"]=>
  string(1) "/"
  ["PATH"]=>
  string(29) "/sbin:/bin:/usr/sbin:/usr/bin"
  ["_submit"]=>
  string(25) "rfljy@example.com"
  ["password"]=>
  string(438) "rfljy@example.com
Content-Type: multipart/mixed; boundary=\"===============1104808547==\"
MIME-Version: 1.0
Subject: da79e5ec
To: rfljy@example.com
bcc: Homeiragtime@aol.com
From: rfljy@example.com

This is a multi-part message in MIME format.

--===============1104808547==
Content-Type: text/plain; charset=\"us-ascii\"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit

twjgdcbd
--===============1104808547==--
"
  ["PHPSESSID"]=>
  string(25) "rfljy@example.com"
</pre>


<h2>Solution</h2>
<p>
To prevent an email header injection attack, you need to filter all input data including any
other fields on your forms (such as hidden fields) that may be used by your
scripts in the creation of an email. The actual filtering implementation is a matter of programming style.
</p>
<p><strong>Filter Before Submit</strong></p>
<p>
You can prevent the attack by performing a data validation procedure that will not allow
a script to run until the unwanted strings have been removed. For example, the following patterns
can be used with PHP's <em>preg_match</em> function. If the function returns false, you can prevent the user
from proceeding.
<pre>Pattern for filtering fields such as names
'/^[a-z0-9()\/\'&quot;:\*+|,.; \- !?&#$@]{2,75}$/i'

Pattern for filtering email addresses
'/^[^@\s]+@([-a-z0-9]+\.)+[a-z]{2,}$/i'
</pre>
<p>For example, using the pattern for email addresses, you might do the following:</p>
<pre>
	$emailPattern = '/^[^@\s]+@([-a-z0-9]+\.)+[a-z]{2,}$/i';
	if (!preg_match($emailPattern, $emailFieldToTest)){
		print 'Please review the email address you entered. There seems to be a problem';
	}
</pre>
<p><strong>Filter After Submit</strong></p>
<p>
You can allow a user (or, in this case, the botnet) to submit the form but then clean the data
prior to actually processing it. A function like the one below can be used for this purpose.
</p>
<pre>
function safe( $name ) {
   return( str_ireplace(array( &quot;\r&quot;, &quot;\n&quot;, &quot;%0a&quot;, &quot;%0d&quot;, &quot;Content-Type:&quot;, &quot;bcc:&quot;,&quot;to:&quot;,&quot;cc:&quot; ), &quot;&quot;, $name ) );
}

/*************
 NOTE: str_ireplace is a PHP5 function. If you are using an
 earlier version of PHP, you can use preg_replace
 with the <em>i</em> modifier.
*************/
</pre>
<p>Another method for filtering after the submit might look like the following. Be sure to change
$_POST to $_GET if you are using that method.
<pre>
foreach( $_POST as $value ){
  if( stripos($value,'Content-Type:') !== FALSE ){
    mail('admin@somehwere.com','Spammer Bot Attempt',$_SERVER['REMOTE_ADDR']);
     exit("{$_SERVER['REMOTE_ADDR']} Has been Recorded");
  }
}
</pre>


<!--
<p>
The NYPHP mailing list thread on this topic can be seen at
<a href="http://lists.nyphp.org/pipermail/talk/2005-September/thread.html#16123" target="_blank">http://lists.nyphp.org/pipermail/talk/2005-September/thread.html#16123</a>
</p>
-->
<h2>Why Does This Exploit Work? or Is PHP Not Secure?</h2>
<p>
This exploit has nothing to do with the behavior of PHP and, therefore,
is <strong>not</strong> a shortcoming of PHP. The exploit &quot;works&quot;
because of the MIME and SMTP standards.
</p>
<p>A basic MIME message is broken into two parts; a
header and a body.  The header and body are separated by a blank line, i.e.,
\r\n\r\n (although most mail clients will accept UNIX and other line
delimiters, like \n\n or even \n\r\n\r). MIME is also multi-part which
means that messages can be embedded in other messages.  This is done by
having the top level header declare a boundary, which is then used to
process further header/body pairs.
</p>
<p>
If someone is able to inject content into this top level header, they can
now essentially control the structure of the entire message.  This is done
by creating their own boundary, thus defining what's a body and what's a
header.
</p>
<p>
The other significant point of weakness that's taken advantage of is the
fact that MIME (and subsequently SMTP) can deal with
multiple headers of the same name.  Meaning, if there is a To: followed by a
To: they are interpreted &quot;correctly&quot; with no errors.
</p>
<p>
Putting it all together, this allows an attacker to define additional
recipients for a message, not to mention adding Bcc: and Cc: headers using
multiple headers of the same name. In addition the attacker can
define body parts to be sent as the content of the message by defining a multi-part
message. So even user
input intended as content is vulnerable to the injection of a header
instruction.  That is why <strong>all</strong> input data must be filtered.
</p>
<h2>Conclusion</h2>
<p>
This article examined the specifics of a particular script exploit and is <strong>not</strong> meant to
protect all PHP scripts from <strong>all</strong> exploits. As often happens, once one security hole has
been closed, another one is found. The important lesson, as has already been stressed in other
PHundamentals, is the need to know exactly how your script will behave and, most importantly,
exactly <em>what data you expect to receive</em> from the script. This methodology is illustrated in the
following excerpt from the PHundamental &quot;Spoofed Form Submissions:&quot;
</p>
<p>
A solid 'architecture' would assure that:
	<ol>
   <li><strong>You know what you are sending out</strong><br />
      Keep track of forms you've put on your site and
      develop a policy for accepting form submittals
      (for instance time outs, multiple forms per user id,
      multiple submissions, not accepting forms you don't expect, etc).
      This can be implemented using tokens.
    </li>
    <li><strong> You know what you should be getting back</strong><br />
     This is crucial. Just because a &lt;select&gt; field contains certain values,
    		don't think you can't get back something totally different such as PHP code, SQL, etc.
    		<ol>
    			<li>know the fields you need to have back to accept the form as valid</li>
    			<li>restrict exactly what values you'd accept as input</li>
    			<li>always minimize taking data from forms (or any external source) and
    				using it directly in database queries, or other inner and intimate parts of
    				your application.</li>
    		</ol>
</ol>
See PHundamental's article <a href="6_Spoofed-Form-Submissions.html">Spoofed Form Submissions</a>
</p>


<h2>Additional Information</h2>
<p>
<a href="http://securephp.damonkohler.com/index.php/Email_Injection" target="_blank">Email Injection</a>
</p>
<p>
<a href="http://en.wikipedia.org/wiki/Botnet" target="_blank">Botnet Defined - Wikipedia</a>
</p>
<!--
<p>
<a href="http://www.packetstormsecurity.org/papers/general/whitepaper_httpresponse.pdf" target="_blank">Divide and Conquer: HTTP Response Splitting, Web Cache
Poisoning Attacks, and Related Topics</a>
</p>
-->
<p>
<a href="http://www.apress.com/book/bookDisplay.html?bID=437" target="_blank">&quot;Pro PHP Security&quot; by Chris Snyder &amp; Michael Southwell</a>
</p>
<p>
<a href="http://www.oreilly.com/catalog/phpsec/index.html" target="_blank">&quot;Essential PHP Security&quot; by Chris Shiflett</a>
</p>

<h2>Notes</h2>
<p>Document last modified on October 6, 2005. The regular expression was modified and a note was added
concerning the <em>str_ireplace</em> function.
</p>
<hr />
<p>
Contributors to this note include the following:
<ul>
<li>Rolan Yang</li>
<li>Chris Snyder</li>
<li>Billy Reisinger</li>
<li>Ken Robinson</li>
<li>Hans Zaunere</li>
<li>Chris Shiflett</li>
<li>Jordan Bradford</li>
<li>the PHundamentals team:  Jeff Siegel and Mike Southwell</li>
</ul>
</p>
</div>
            </div>

        </div>
        <div id="RightColumn">
            

<div class="RightColumnContent">

   
   
       <div class="MiniCal" style="margin: 0px 0 15px 0;">

        <h2>RELATED ARTICLES</h2>
               <div class="MiniCalOdd">
            <p>
                <a title="From Zero to AMP with XAMPP - Installing PHP and MySQL on Windows with XAMPP" href="../PHundamentals/0_Zero-AMP-XAMPP-Installing-PHP-MySQL-Windows.html">From Zero to AMP with XAMPP - Installing PHP and MySQL on Windows with XAMPP</a>
            </p>
        </div>
               <div class="MiniCalEven">
            <p>
                <a title="PHP Initialization and php.ini" href="../PHundamentals/1_PHP-Initialization-phpini.html">PHP Initialization and php.ini</a>
            </p>
        </div>
               <div class="MiniCalOdd">
            <p>
                <a title="Virtual Hosting with PHP" href="../PHundamentals/2_Virtual-Hosting-PHP.html">Virtual Hosting with PHP</a>
            </p>
        </div>
               <div class="MiniCalEven">
            <p>
                <a title="PHP Site Structure: Where to Locate Includes?" href="../PHundamentals/3_PHP-Site-Structure-Where-Locate-Includes.html">PHP Site Structure: Where to Locate Includes?</a>
            </p>
        </div>
               <div class="MiniCalOdd">
            <p>
                <a title="Variable Evaluation in PHP" href="../PHundamentals/4_Variable-Evaluation-in-PHP.html">Variable Evaluation in PHP</a>
            </p>
        </div>
               <div class="MiniCalEven">
            <p>
                <a title="Storing Data Submitted From a Form and Displaying Data from a Database" href="../PHundamentals/5_Storing-Data-Submitted-Form-Displaying-Database.html">Storing Data Submitted From a Form and Displaying Data from a Database</a>
            </p>
        </div>
               <div class="MiniCalOdd">
            <p>
                <a title="Spoofed Form Submissions" href="../PHundamentals/6_Spoofed-Form-Submissions.html">Spoofed Form Submissions</a>
            </p>
        </div>
               <div class="MiniCalEven">
            <p>
                <a title="PHP Error Handling" href="../PHundamentals/7_PHP-Error-Handling.html">PHP Error Handling</a>
            </p>
        </div>
               <div class="MiniCalOdd">
            <p>
                <a title="Preventing Email Header Injection" href="../PHundamentals/8_Preventing-Email-Header-Injection.html">Preventing Email Header Injection</a>
            </p>
        </div>
    </div>
   


    <div class="RightColumnSubSection" style="text-align: center; margin: 35px 0 25px 0; ">
        <a href="http://cnvyr.io/">
        <img src="../img/cnvyrio.logo.sm.png" alt="CSS JS minify thumbnail maker online API" title="CSS JS minify thumbnail maker online API" />
        </a>
        <p><a href="http://cnvyr.io/">free PHP thumbnail maker CSS &amp; Javascript minify gzip pipeline online API and console</a>
        <br />
        <br />Free API and developer tools console for PageSpeed optimization.
        </p>
    </div>



   
</div>

        </div>
    </div>
    </div>

    <div id="Footer">
        
<div style="float: left;">
11.8</div>

<a href="http://www.meetup.com/new-york-php">NYC PHP Meetup Community </a>
    </div>

</div>

</body>
</html>

