<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-51353372-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-51353372-3');
</script>
   <TITLE> [nycphp-talk] A SQL Query Conundrum. I Need Your Assistance...
   </TITLE>
   <LINK REL="Index" HREF="http://nyphp.org/pipermail/talk/2006-March/index.html" >
   <LINK REL="made" HREF="mailto:talk%40lists.nyphp.org?Subject=Re:%20Re%3A%20%5Bnyphp-talk%5D%20A%20SQL%20Query%20Conundrum.%20I%20Need%20Your%20Assistance...&In-Reply-To=%3C00e101c63dda%24a3a7dd10%246500a8c0%40enobrev%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017653.html">
   <LINK REL="Next"  HREF="017645.html">
 <meta name="description" content="PHP jobs stackware web application support and development forums for Mongo LAMP MySQL SQL Windows IIS Linux." />
<meta name="author" content="Stackware Web Development - http://stackware.com" />
<meta name="verify-v1" content="zWMoPwMn/dolscLkjLXTpRqgr9K8bzlzL1vM9WTjpHc=" />
<meta name="msvalidate.01" content="F85F81C1D0BAB5C349E8395628845E27" />
<meta name="y_key" content="265502be3db4fb6e" />
</HEAD>
         <BODY BGCOLOR="#ffffff">
<h1 style="float: right; margin: 0; padding: 0 0 0 15px;"><a href="https://www.meetup.com/new-york-php/">NYCPHP Meetup</a></h1><h1><a href="http://www.nyphp.org">NYPHP.org</a></h1>
   <H1>[nycphp-talk] A SQL Query Conundrum. I Need Your Assistance...</H1>
    <B>Mark Armendariz</B> 
    <A HREF="mailto:talk%40lists.nyphp.org?Subject=Re:%20Re%3A%20%5Bnyphp-talk%5D%20A%20SQL%20Query%20Conundrum.%20I%20Need%20Your%20Assistance...&In-Reply-To=%3C00e101c63dda%24a3a7dd10%246500a8c0%40enobrev%3E"
       TITLE="[nycphp-talk] A SQL Query Conundrum. I Need Your Assistance...">enolists at gmail.com
       </A><BR>
    <I>Thu Mar  2 04:21:06 EST 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="017653.html">[nycphp-talk] A SQL Query Conundrum. I Need Your Assistance...
</A></li>
        <LI>Next message: <A HREF="017645.html">[nycphp-talk] A SQL Query Conundrum. I Need Your Assistance...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17654">[ date ]</a>
              <a href="thread.html#17654">[ thread ]</a>
              <a href="subject.html#17654">[ subject ]</a>
              <a href="author.html#17654">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I've a 2 part answer...

First, your problem.

&gt;<i> On Behalf Of Peter Sawczynec
</I>&gt;<i> ...
</I>&gt;<i> I need to get all the active users email and name for personalization.
</I>&gt;<i> 
</I>&gt;<i> I need the correct SELECT query addressing two tables that 
</I>&gt;<i> have a one to many relationship linked by &quot;user_id&quot; like the 
</I>&gt;<i> relationship shown below:
</I>&gt;<i> 
</I>&gt;<i> Table: Users
</I>&gt;<i> Fields: id   user_id 
</I>&gt;<i> 
</I>&gt;<i> Table: User_Attributes
</I>&gt;<i> Fields: id   user_id   attribute_name   attribute_value
</I>

&gt;<i> On Behalf Of Carlos A Hoyos
</I>&gt;<i> ...
</I>&gt;<i> 1- You can join with the same table multiple times just by 
</I>&gt;<i> giving it different alias.
</I>&gt;<i> So for example this following query will get all users id,
</I>
He's correct, except you'll want more control within the joins than Carlos'
example.

Here's a way to do it (worked correctly on my local mysql 4.023)

SELECT
    user.user_id,
    email.attribute_value as user_email,
    name.attribute_value as user_name
FROM
    users user
LEFT JOIN
    user_attributes active ON
    user.user_id = active.user_id 
    AND active.attribute_name = 'active' 
LEFT JOIN
    user_attributes name ON
    user.user_id = name.user_id 
    AND name.attribute_name = 'name' 
LEFT JOIN
    user_attributes email ON
    user.user_id = email.user_id 
    AND email.attribute_name = 'email' 
WHERE active.attribute_value = 'yes'

&gt;<i> 89 78 email <A HREF="http://lists.nyphp.org/mailman/listinfo/talk">joe at joe.com</A>
</I>&gt;<i> 90 78 name joe
</I>&gt;<i> 91 78 active yes
</I>&gt;<i> 92 78 title CEO
</I>&gt;<i> 93 79 email <A HREF="http://lists.nyphp.org/mailman/listinfo/talk">sal at sal.com</A>
</I>&gt;<i> 94 79 name sal
</I>
95 79 email <A HREF="http://lists.nyphp.org/mailman/listinfo/talk">another at sal.com</A>  // and another email for good ol' sal for good
measure

produces this (sorry if spacing's off):

user_id   	 user_email   	 user_name
78 	<A HREF="http://lists.nyphp.org/mailman/listinfo/talk">joe at joe.com</A> 	joe
79 	<A HREF="http://lists.nyphp.org/mailman/listinfo/talk">sal at sal.com</A> 	sal
79 	<A HREF="http://lists.nyphp.org/mailman/listinfo/talk">another at sal.com</A> 	sal

&gt;<i> On Behalf Of Kenneth Dombrowski
</I>&gt;<i> ...
</I>&gt;<i> But the &quot;at1.attribute_id != at2.attribute_id&quot; thing is 
</I>&gt;<i> extremely ugly, and moreso if you begin supporting 3, 4, + 
</I>&gt;<i> email attributes
</I>
Close, but there's no need for a separate join for each email.

Essentially, you're getting a list of users from the users table, and then
attaching attribute values pertaining to that user per attribute.  The joins
hold their constraints on the data they need and the only 'where' condition
you need is to make sure the user is active.

This works well if only ONE of the attributes has multiple values (email in
this case).  If they would also have multiple phone numbers your results
might get messy (at least for a single query, for that you'd want different
queries per joined list).

&gt;<i> On Behalf Of Anirudhsinh Zala
</I>&gt;<i> ...
</I>&gt;<i> =&gt; Probably best way is to merge both tables &quot;User&quot; and 
</I>&gt;<i> &quot;User_attributes&quot; as there is no any good advantage of this 
</I>&gt;<i> kind of normalization.
</I>
I'm GUESSING that the reason you have the tables set up this way is for a
dynamic survey system of sorts, in which you'll want someone to be allowed
to add / remove fields as they wish without messing with the data structure.
So removing the normalization probably won't work for you in this respect.
If it's something else, you might want be sure you've good reason to make a
database engine on top of a damned fine database engine.

But, the part of Anirudhsinh's argument that I agree with is that the users
table has no purpose.  Now, if you're adding fields to it (username and
password for instance), and have your reasons for meta columns that don't
involve recreations and wheels then forget this part of the problem
entirely.  BUT, if it ONLY holds a user_id, consider getting rid of it.  You
could use this query instead (tested correctly as well): 

SELECT
    active.user_id,
    email.attribute_value as user_email,
    name.attribute_value as user_name
FROM
    user_attributes active
LEFT JOIN
    user_attributes name ON
    active.user_id = name.user_id 
    AND name.attribute_name = 'name' 
LEFT JOIN
    user_attributes email ON
    active.user_id = email.user_id 
    AND email.attribute_name = 'email' 
WHERE
    active.attribute_value = 'yes'



Good luck!!!

Mark Armendariz
<A HREF="http://www.enobrev.com/">http://www.enobrev.com/</A>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017653.html">[nycphp-talk] A SQL Query Conundrum. I Need Your Assistance...
</A></li>
	<LI>Next message: <A HREF="017645.html">[nycphp-talk] A SQL Query Conundrum. I Need Your Assistance...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17654">[ date ]</a>
              <a href="thread.html#17654">[ thread ]</a>
              <a href="subject.html#17654">[ subject ]</a>
              <a href="author.html#17654">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.nyphp.org/mailman/listinfo/talk">More information about the talk
mailing list</a><br>
</body></html>
