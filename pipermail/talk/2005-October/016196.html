<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-51353372-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-51353372-3');
</script>
   <TITLE> [nycphp-talk] fun with proc_open
   </TITLE>
   <LINK REL="Index" HREF="http://nyphp.org/pipermail/talk/2005-October/index.html" >
   <LINK REL="made" HREF="mailto:talk%40lists.nyphp.org?Subject=Re:%20Re%3A%20%5Bnyphp-talk%5D%20fun%20with%20proc_open&In-Reply-To=%3C43444122.5000108%40phpwerx.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="016192.html">
   <LINK REL="Next"  HREF="016241.html">
 <meta name="description" content="PHP jobs stackware web application support and development forums for Mongo LAMP MySQL SQL Windows IIS Linux." />
<meta name="author" content="Stackware Web Development - http://stackware.com" />
<meta name="verify-v1" content="zWMoPwMn/dolscLkjLXTpRqgr9K8bzlzL1vM9WTjpHc=" />
<meta name="msvalidate.01" content="F85F81C1D0BAB5C349E8395628845E27" />
<meta name="y_key" content="265502be3db4fb6e" />
</HEAD>
         <BODY BGCOLOR="#ffffff">
<h1 style="float: right; margin: 0; padding: 0 0 0 15px;"><a href="https://www.meetup.com/new-york-php/">NYCPHP Meetup</a></h1><h1><a href="http://www.nyphp.org">NYPHP.org</a></h1>
   <H1>[nycphp-talk] fun with proc_open</H1>
    <B>Dan Cech</B> 
    <A HREF="mailto:talk%40lists.nyphp.org?Subject=Re:%20Re%3A%20%5Bnyphp-talk%5D%20fun%20with%20proc_open&In-Reply-To=%3C43444122.5000108%40phpwerx.net%3E"
       TITLE="[nycphp-talk] fun with proc_open">dcech at phpwerx.net
       </A><BR>
    <I>Wed Oct  5 17:09:54 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="016192.html">[nycphp-talk] Problem while compiling php
</A></li>
        <LI>Next message: <A HREF="016241.html">[nycphp-talk] fun with proc_open
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16196">[ date ]</a>
              <a href="thread.html#16196">[ thread ]</a>
              <a href="subject.html#16196">[ subject ]</a>
              <a href="author.html#16196">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi all,

Firstly, apologies for the long email, I couldn't think of a less 
verbose way to describe the issues I'm experiencing.

I'm in the midst of writing a little program for executing long-running 
processes in the background from php and monitoring their output as they 
run.

The problem I'm running into is that when I execute a process using 
proc_open and try to read any output from stdout and stderr I am running 
into some odd behavior.

This only seems to happen under windows, running the same script on my 
debian server works as expected.

The first read from stdout is fine, but then it doesn't get any more 
output from stdout until the end of the script.

Is there some issue with using stdout and stderr together in this way 
that I don't know about?

My test code looks like this:

&lt;?php

// allow script to run for 5 minutes
set_time_limit(300);

// maximum length of blocks to read from process
define('FREAD_LENGTH',1024*10);

$cmd = 'php '.dirname(__FILE__).DIRECTORY_SEPARATOR.'sleep.php';

$descriptorspec = array(
   1 =&gt; array('pipe','w'), // stdout
   2 =&gt; array('pipe','w'), // stderr
);

$process = proc_open($cmd,$descriptorspec,$pipes);

if (!is_resource($process)) {
   echo 'failed'.&quot;\n&quot;;
   exit(1);
}

// don't block process stdout or stderr
stream_set_blocking($pipes[1],0);
stream_set_blocking($pipes[2],0);

// don't buffer stdout or stderr
stream_set_write_buffer($pipes[1],0);
stream_set_write_buffer($pipes[2],0);

while (true) {
   // read process stdout
   $stdout = fread($pipes[1],FREAD_LENGTH);
   if (strlen($stdout) &gt; 0) {
     echo 'stdout:'. $stdout;
     flush();
   }

   // read process stderr
   $stderr = fread($pipes[2],FREAD_LENGTH);
   if (strlen($stderr) &gt; 0) {
     echo 'stderr:'. $stderr;
     flush();
   }

   // end when both pipes are closed
   if (feof($pipes[1]) &amp;&amp; feof($pipes[2])) {
     break;
   }

   // wait for more output
   sleep(1);
}

// close process stdout and stderr
fclose($pipes[1]);
fclose($pipes[2]);

// grab exit code
$exitcode = proc_close($process);

echo 'exitcode:'. $exitcode .&quot;\n&quot;;

// end of script

sleep.php is a simple script that outputs some data:

&lt;?php

ob_implicit_flush();

echo('started'.&quot;\n&quot;);

for ($i = 1;$i &lt;= 10;$i++) {
	sleep(1);
	echo($i.&quot;\n&quot;);
}

fwrite(STDERR,'done'.&quot;\n&quot;);

// end of script

Running the first script from command line or web browser should output:

stdout:started
stdout:1
stdout:2
stdout:3
stdout:4
stdout:5
stdout:6
stdout:7
stdout:8
stdout:9
stdout:10
stderr:done
exitcode:0

On windows I'm seeing:

stdout:started
stderr:done
stdout:1
2
3
4
5
6
7
8
9
10
exitcode:0

I've managed to get the same functionality using popen and redirecting 
stderr to a fifo or tempfile, but proc_open seems like the cleaner 
solution if I can get it to work the way I want.

Any ideas?

Dan

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="016192.html">[nycphp-talk] Problem while compiling php
</A></li>
	<LI>Next message: <A HREF="016241.html">[nycphp-talk] fun with proc_open
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#16196">[ date ]</a>
              <a href="thread.html#16196">[ thread ]</a>
              <a href="subject.html#16196">[ subject ]</a>
              <a href="author.html#16196">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.nyphp.org/mailman/listinfo/talk">More information about the talk
mailing list</a><br>
</body></html>
