<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-51353372-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-51353372-3');
</script>
   <TITLE> [nycphp-talk] smtp socket error that i just don't get
   </TITLE>
   <LINK REL="Index" HREF="http://nyphp.org/pipermail/talk/2003-November/index.html" >
   <LINK REL="made" HREF="mailto:talk%40lists.nyphp.org?Subject=Re:%20Re%3A%20%5Bnyphp-talk%5D%20smtp%20socket%20error%20that%20i%20just%20don%27t%20get&In-Reply-To=%3CE1AIEmc-0006bk-Ru%40server1057.webserver33.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="006284.html">
   <LINK REL="Next"  HREF="006288.html">
 <meta name="description" content="PHP jobs stackware web application support and development forums for Mongo LAMP MySQL SQL Windows IIS Linux." />
<meta name="author" content="Stackware Web Development - http://stackware.com" />
<meta name="verify-v1" content="zWMoPwMn/dolscLkjLXTpRqgr9K8bzlzL1vM9WTjpHc=" />
<meta name="msvalidate.01" content="F85F81C1D0BAB5C349E8395628845E27" />
<meta name="y_key" content="265502be3db4fb6e" />
</HEAD>
         <BODY BGCOLOR="#ffffff">
<h1 style="float: right; margin: 0; padding: 0 0 0 15px;"><a href="https://www.meetup.com/new-york-php/">NYCPHP Meetup</a></h1><h1><a href="http://www.nyphp.org">NYPHP.org</a></h1>
   <H1>[nycphp-talk] smtp socket error that i just don't get</H1>
    <B>Mark Armendariz</B> 
    <A HREF="mailto:talk%40lists.nyphp.org?Subject=Re:%20Re%3A%20%5Bnyphp-talk%5D%20smtp%20socket%20error%20that%20i%20just%20don%27t%20get&In-Reply-To=%3CE1AIEmc-0006bk-Ru%40server1057.webserver33.com%3E"
       TITLE="[nycphp-talk] smtp socket error that i just don't get">nyphp at enobrev.com
       </A><BR>
    <I>Fri Nov  7 17:08:53 EST 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="006284.html">[nycphp-talk] PHP Conference Pictures
</A></li>
        <LI>Next message: <A HREF="006288.html">[nycphp-talk] smtp socket error that i just don't get
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6286">[ date ]</a>
              <a href="thread.html#6286">[ thread ]</a>
              <a href="subject.html#6286">[ subject ]</a>
              <a href="author.html#6286">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello all,
 
I'm hoping you guys can lend a hand... Below is some code I grabbed from the
manual (<A HREF="http://www.php.net/manual/en/ref.mail.php">http://www.php.net/manual/en/ref.mail.php</A>) for sending mail directly
through the socket rather than using the mail command.  Now it works well on
my server, but when I installed it on my client's server, I get an endless
loop of errors like so:
 
Notice: fputs(): send of 41 bytes failed with errno=32 Broken pipe in
/usr/local/etc/httpd/htdocs/bostonindoorgames/admin/mailer.php on line 136

Notice: fputs(): send of 42 bytes failed with errno=32 Broken pipe in
/usr/local/etc/httpd/htdocs/bostonindoorgames/admin/mailer.php on line 136
 
The code is below, and line 136 is right under the comment // --------
PROBLEM STARTS HERE!!! ----------------
 
Now, as I mentioned, this same code works on my server just fine.  There is
surrounding code, but it's all involved in setting the vars and such for the
email itself.  I assure you all vars are set properly, as I've checked them
at least 6 times.  I thought that there may possibly be some kind of socket
issue, but then wouldn't it have a problem connecting to the socket in the
first place? Or even sending the HELO command after the connect?
 
When searching for the error, I came up with this (which is a ll gibberish
to me):
 
Broken pipe
===========

This condition is often normal, and the message is merely
informational (as when piping many lines to the head program).
The condition occurs when a write on a pipe does not find a
reading process. This usually generates a signal to the executing
program, but this message displays when the program ignores the
signal.

Check the process at the end of the pipe to see why it exited.

The symbolic name forthis error is EPIPE, errno=32.

 
 
 
   // Open socket to SMTP server
   $connect = fsockopen (ini_get('SMTP'), ini_get('smtp_port'), $errno,
$errstr, 30) or die('Could not talk to the sendmail server!'); 
   $rcv = fgets($connect, 1024); 
  
   // Send greeting to SMTP server 
   fputs($connect, 'HELO {mail.' . $_SERVER['SERVER_NAME'] . '}' . $nl); 
   $rcv = fgets($connect, 1024); 
   
   // Loop through recipients and send mail
   foreach($recipients_array as $recipient) {
   
    if (strlen($recipient['recipient_name'])) {
     $to_name = $recipient['recipient_name'];
    } else {
     $to_name = '';
    }
    
    $to_address = $recipient['recipient_email'];
    
    if (strlen($queue_array['unsubscribe_text'])) {
     $html_unsubscribe_link  = '&lt;a href=&quot;' . SITE_URL .
'unsubscribe.php?email=' . $to_address . '&quot;&gt;' .
$queue_array['unsubscribe_text'] . '&lt;/a&gt;';
     $ascii_unsubscribe_link = $queue_array['unsubscribe_text'] . ': ' .
SITE_URL . 'unsubscribe.php?email=' . $to_address;
    } else {
     $html_unsubscribe_link  = '&lt;a href=&quot;' . SITE_URL .
'unsubscribe.php?email=' . $to_address . '&quot;&gt;Unsubscribe&lt;/a&gt;';
     $ascii_unsubscribe_link = 'Unsubscribe: ' . SITE_URL .
'unsubscribe.php?email=' . $to_address;
    }
   
    if (strlen(trim($to_name))) {
     $to_email = $to_name . ' &lt;' . $to_address . '&gt;';
    } else {
     $to_email = $to_address;
    }
    
    $outer_boudary  = &quot;----=_EnoOuterBoundary_000&quot;;
    $inner_boudary  = &quot;----=_EnoInnerBoundary_001&quot;;
    
    $message_header = 'From: ' . $from_name . ' &lt;' . $from_email . '&gt;' . $nl
        . 'To: ' . $to_email . $nl
        . 'Subject: ' . $subject . $nl
        . 'MIME-Version: 1.0' . $nl
        . 'X-Mailer: Enobrev Mailer Version 1.0' . $nl
        . 'Content-Type: multipart/mixed;'
        . &quot;\t&quot; . 'boundary=&quot;' . $outer_boudary . '&quot;' . $nl;
    
    // Messages start with text/html alternatives
    $message  = 'This is a multi-part message in MIME format.' . $nl . $nl
        . '--' . $outer_boudary . $nl
        . 'Content-Type: multipart/alternative;' . $nl
        . &quot;\t&quot; . 'boundary=&quot;' . $inner_boudary . '&quot;' . $nl . $nl
    
    // PLAIN SECTION
        . '--' . $inner_boudary . $nl
        . 'Content-Type: text/plain;' . $nl
        . &quot;\t&quot; . 'charset=&quot;iso-8859-1&quot;' . $nl
        . 'Content-Transfer-Encoding: quoted-printable' . $nl . $nl
        
    // PLAIN TEXT
        . stripslashes($ascii_message . $nl . $nl . $ascii_unsubscribe_link)
. $nl . $nl
    
    // HTML SECTION
        . '--' . $inner_boudary . $nl
        . 'Content-Type: text/html;' . $nl
        . &quot;\t&quot; . 'charset=&quot;iso-8859-1&quot;' . $nl
        . 'Content-Transfer-Encoding: base64' . $nl . $nl
        
    // HTML
        . chunk_split(base64_encode($html_message . '&lt;br /&gt;&lt;br /&gt;' .
$html_unsubscribe_link)) . $nl . $nl
    
    // END INNER BOUNDARY
        . '--' . $inner_boudary . '--' . $nl . $nl
    
    // END MESSAGE
        . '--' . $outer_boudary . '--' . $nl;
   
 
    // ------------------------------------------- PROBLEM STARTS HERE!!!
------------------------------------------------------
   
    fputs($connect, 'MAIL FROM:' . $from_email . $nl);  // &lt;-- LINE 136
    $rcv = fgets($connect, 1024); 
    
    fputs($connect, 'RCPT TO:' . $to_address . $nl); 
    $rcv = fgets($connect, 1024); 
    
    fputs($connect, 'DATA' . $nl); 
    $rcv = fgets($connect, 1024); 
     
    fputs($connect, $message_header . $message . $nl); 
    $rcv = fgets($connect, 1024); 
    
    fputs($connect, '.' . $nl); 
    $rcv = fgets($connect, 1024);
    
    fputs($connect, 'RSET' . $nl); 
    $rcv = fgets($connect, 1024); 
    
    echo 'sent to ' . htmlspecialchars($to_email) . '&lt;br /&gt;';
  
    $db-&gt;Execute('DELETE FROM ' . TABLE_QUEUE_RECIPIENTS 
        . ' WHERE queue_id = ' . $PassedVars['queue_id']
        . ' AND recipient_id = ' . $recipient['recipient_id']);
   }
   
   fputs ($connect, 'QUIT' . $nl); 
   $rcv = fgets ($connect, 1024); 
   echo $rcv;
   
   fclose($connect); 
   ini_restore('sendmail_from'); 
 
 
 
 
 
 
thank you for your help, and have a great weekend!!!
 
Mark
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.nyphp.org/pipermail/talk/attachments/20031107/2451e8ac/attachment.html">http://lists.nyphp.org/pipermail/talk/attachments/20031107/2451e8ac/attachment.html</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="006284.html">[nycphp-talk] PHP Conference Pictures
</A></li>
	<LI>Next message: <A HREF="006288.html">[nycphp-talk] smtp socket error that i just don't get
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#6286">[ date ]</a>
              <a href="thread.html#6286">[ thread ]</a>
              <a href="subject.html#6286">[ subject ]</a>
              <a href="author.html#6286">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.nyphp.org/mailman/listinfo/talk">More information about the talk
mailing list</a><br>
</body></html>
