<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-51353372-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-51353372-3');
</script>
   <TITLE> [nycphp-talk] MySQL Tips/Tricks from Sept Newsletter
   </TITLE>
   <LINK REL="Index" HREF="http://nyphp.org/pipermail/talk/2003-September/index.html" >
   <LINK REL="made" HREF="mailto:talk%40lists.nyphp.org?Subject=Re:%20Re%3A%20%5Bnyphp-talk%5D%20MySQL%20Tips/Tricks%20from%20Sept%20Newsletter&In-Reply-To=%3C005601c3879c%24027f7020%240200a8c0%40thinkpad%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005739.html">
   <LINK REL="Next"  HREF="005740.html">
 <meta name="description" content="PHP jobs stackware web application support and development forums for Mongo LAMP MySQL SQL Windows IIS Linux." />
<meta name="author" content="Stackware Web Development - http://stackware.com" />
<meta name="verify-v1" content="zWMoPwMn/dolscLkjLXTpRqgr9K8bzlzL1vM9WTjpHc=" />
<meta name="msvalidate.01" content="F85F81C1D0BAB5C349E8395628845E27" />
<meta name="y_key" content="265502be3db4fb6e" />
</HEAD>
         <BODY BGCOLOR="#ffffff">
<h1 style="float: right; margin: 0; padding: 0 0 0 15px;"><a href="https://www.meetup.com/new-york-php/">NYCPHP Meetup</a></h1><h1><a href="http://www.nyphp.org">NYPHP.org</a></h1>
   <H1>[nycphp-talk] MySQL Tips/Tricks from Sept Newsletter</H1>
    <B>jon baer</B> 
    <A HREF="mailto:talk%40lists.nyphp.org?Subject=Re:%20Re%3A%20%5Bnyphp-talk%5D%20MySQL%20Tips/Tricks%20from%20Sept%20Newsletter&In-Reply-To=%3C005601c3879c%24027f7020%240200a8c0%40thinkpad%3E"
       TITLE="[nycphp-talk] MySQL Tips/Tricks from Sept Newsletter">jonbaer at jonbaer.net
       </A><BR>
    <I>Tue Sep 30 17:44:21 EDT 2003</I>
    <P><UL>
        <LI>Previous message: <A HREF="005739.html">[nycphp-talk] PHP Timing Mechanism
</A></li>
        <LI>Next message: <A HREF="005740.html">[nycphp-talk] MySQL Tips/Tricks from Sept Newsletter
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5737">[ date ]</a>
              <a href="thread.html#5737">[ thread ]</a>
              <a href="subject.html#5737">[ subject ]</a>
              <a href="author.html#5737">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE><A HREF="http://www.mysql.com/newsletter/2003-09/">http://www.mysql.com/newsletter/2003-09/</A>

MYSQL TIPS &amp; HINTS

Using ORDER BY with UPDATE to resolve the
duplicate key problem

    Indrek Siitan

    To illustrate the problem, let us create a small
    sample table:
    
      CREATE TABLE items (
        id INT NOT NULL PRIMARY KEY,
        name VARCHAR(32)
      ); 
    
    Let's add a couple of rows as well:
    
      INSERT INTO items VALUES (1,'bar'),(2,'qux');
    
    Now, we want to add an entry named &quot;foo&quot; with an
    ID of 1, and shift all of the existing items up by
    one. Easy, you say - just add 1 to the id field
    values and then insert the new row:
    
      UPDATE items SET id=id+1;
      INSERT INTO items VALUES (1,'foo');
    
    In theory, everything looks fine. In real life,
    however, the UPDATE query most probably bails out
    with the following error:
    
      ERROR 1062: Duplicate entry '2' for key 1
    
    This happens because key constraints are checked
    before updating each row (with MyISAM tables that
    are non-transactional, there's no other way, and
    for some reason InnoDB follows the same path). The
    update is done in the order the rows are stored in
    the table files, which, in case you haven't mixed
    DELETEs and INSERTs and caused the table to get
    fragmented, is the order you have inserted the
    rows into the table. So if MySQL starts to process
    the first row and tries to increment the id field
    by 1, the result of 2 already exists in the table
    and produces the error above, although it would be
    increased next and the final query result would
    not violate the key uniqueness.
    
    But not to worry, MySQL has extended the UDPATE
    syntax with a possible ORDER BY clause, that will
    help us solve this problem. If we change the
    update query to:
    
    UPDATE items SET id=id+1 ORDER BY id DESC;
    
    With this ORDER BY clause, MySQL processes rows in
    descending order of id number: First, it updates 2
    to 3, and then 1 to 2.  Consequently, no
    duplicate-key violation occurs and the statement
    succeeds.
    
    The ORDER BY clause in UPDATE is available in
    MySQL server version 4.0.0 and newer.

Is row locking really necessary in multi-table
updates?

    Is row locking really necessary in a multi-table
    update, where some of the tables are only read
    during the update. Couldn't you speed up the
    updates, if the row locking would not be used?
    
    Consider the example below:
    ....
    mysql&gt; create table table1(a int, b int) type =
    innodb;
    Query OK, 0 rows affected (0.02 sec)
    
    mysql&gt; create table table2(a int, b int) type =
    innodb;
    Query OK, 0 rows affected (0.50 sec)
    
    mysql&gt; insert into table1 values (10, 20);
    Query OK, 1 row affected (2.68 sec)
    
    mysql&gt; insert into table2 values (10, 20);
    Query OK, 1 row affected (2.76 sec)
    
    mysql&gt; update table1, table2 set table1.b = 100
    where table1.a = 
    table2.a;
    Query OK, 1 row affected (48.31 sec)
    Rows matched: 1  Changed: 1  Warnings: 0
    ....
    
    If we do not lock rows in table2, then the changes
    to table1 are based on an old consistent snapshot
    of table2. If that snapshot is very old, we may
    get really unexpected update results. So it is not
    good idea to set a trap to users by removing the
    row locks on table2.
    
    When you are doing multi-table updates, you might
    run into deadlocks.
    Deadlocks are a problem that needs to be taken
    into account, when using row locking and
    transactions. The link
    <A HREF="http://www.innodb.com/ibman.html#Cope_with_deadlocks">http://www.innodb.com/ibman.html#Cope_with_deadlocks</A>
    contains some help in avoiding them.

TIP: Maximum size of a BLOB

    MySQL supports BLOBs (Binary Large Objects), which
    means you can store any binary file into MySQL.
    Many people ask, what is the maximum size of a
    BLOB in MySQL.
    
    The theoretical limit in MySQL 4.0 is 2G, however
    each blob requires generally to have 3 copies of
    it in the memory (stored in various buffers) so
    you need a lot of memory, if you have large BLOBs
    stored in MySQL. This is the reason, why the
    theoretical limit can be reached only on 64bit
    systems. The Practical limits are around some
    hundreds of megs per BLOB.

pgp key: <A HREF="http://www.jonbaer.net/jonbaer.asc">http://www.jonbaer.net/jonbaer.asc</A>
fingerprint: F438 A47E C45E 8B27 F68C 1F9B 41DB DB8B 9A0C AF47


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005739.html">[nycphp-talk] PHP Timing Mechanism
</A></li>
	<LI>Next message: <A HREF="005740.html">[nycphp-talk] MySQL Tips/Tricks from Sept Newsletter
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5737">[ date ]</a>
              <a href="thread.html#5737">[ thread ]</a>
              <a href="subject.html#5737">[ subject ]</a>
              <a href="author.html#5737">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.nyphp.org/mailman/listinfo/talk">More information about the talk
mailing list</a><br>
</body></html>
