<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-51353372-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-51353372-3');
</script>
   <TITLE> [nycphp-talk] *Repost from DEV List* LDAP Authentication 	AgainstMicroshaft's Active Directory
   </TITLE>
   <LINK REL="Index" HREF="http://nyphp.org/pipermail/talk/2004-February/index.html" >
   <LINK REL="made" HREF="mailto:talk%40lists.nyphp.org?Subject=Re:%20Re%3A%20%5Bnyphp-talk%5D%20%2ARepost%20from%20DEV%20List%2A%20LDAP%20Authentication%20%0A%09AgainstMicroshaft%27s%20Active%20Directory&In-Reply-To=%3C33232.65.211.92.98.1077649383.squirrel%40www.keithjr.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008058.html">
   <LINK REL="Next"  HREF="008064.html">
 <meta name="description" content="PHP jobs stackware web application support and development forums for Mongo LAMP MySQL SQL Windows IIS Linux." />
<meta name="author" content="Stackware Web Development - http://stackware.com" />
<meta name="verify-v1" content="zWMoPwMn/dolscLkjLXTpRqgr9K8bzlzL1vM9WTjpHc=" />
<meta name="msvalidate.01" content="F85F81C1D0BAB5C349E8395628845E27" />
<meta name="y_key" content="265502be3db4fb6e" />
</HEAD>
         <BODY BGCOLOR="#ffffff">
<h1 style="float: right; margin: 0; padding: 0 0 0 15px;"><a href="https://www.meetup.com/new-york-php/">NYCPHP Meetup</a></h1><h1><a href="http://www.nyphp.org">NYPHP.org</a></h1>
   <H1>[nycphp-talk] *Repost from DEV List* LDAP Authentication 	AgainstMicroshaft's Active Directory</H1>
    <B>keith at keithjr.net</B> 
    <A HREF="mailto:talk%40lists.nyphp.org?Subject=Re:%20Re%3A%20%5Bnyphp-talk%5D%20%2ARepost%20from%20DEV%20List%2A%20LDAP%20Authentication%20%0A%09AgainstMicroshaft%27s%20Active%20Directory&In-Reply-To=%3C33232.65.211.92.98.1077649383.squirrel%40www.keithjr.net%3E"
       TITLE="[nycphp-talk] *Repost from DEV List* LDAP Authentication 	AgainstMicroshaft's Active Directory">keith at keithjr.net
       </A><BR>
    <I>Tue Feb 24 14:03:03 EST 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="008058.html">[nycphp-talk] *Repost from DEV List* LDAP Authentication Against	Microshaft's Active Directory
</A></li>
        <LI>Next message: <A HREF="008064.html">[nycphp-talk] *Repost from DEV List* LDAP Authentication	AgainstMicroshaft's Active Directory
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8062">[ date ]</a>
              <a href="thread.html#8062">[ thread ]</a>
              <a href="subject.html#8062">[ subject ]</a>
              <a href="author.html#8062">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I posted this earlier today - you might want to take a look at it and see
if it can help you...

-------


I noticed someone asking about Active Directory authentication using
straight up php - so I figured that I would send this along.

This is a snippet of a login script for a calendar scheduling ap that I
wrote in PHP for a local intranet. You would make a login form, with post
variables of username and password, and it will authenticate them to the
AD server.

How this works: it connects to the LDAP server with a valid login - which
I created the username ldap in active directory, to query the database,
since it would not allow anonymous access. You would look up the correct
username for that account by querying the smaaccountname field for the
username that they entered. If that exists, then get the correct username
to bind to the server with, disconnect, and retry to connect with the
users proper username and their password. If it connects, you know that it
is a valid username.

I have used this script in their helpdesk application so that passwords
were being checked vs active directory instead of the internal help desk
application's passwords.

This is just one way of doing it - if anyone else has comments or
questions, please feel free to let me now!

// connect to LDAP server
$ldap = ldap_connect(&quot;172.17.1.11&quot;) or die(&quot;Cannot connect to the ldap
server :/&quot;);
$oudc = &quot;cn=Users, dc=thompsonhealth, dc=org&quot;;
$searchdc = &quot;dc=thompsonhealth, dc=org&quot;;
$dn2 = &quot;cn=ldap, &quot;.$oudc;
$password = &quot;password&quot;;
$auth = false;
//look up OU
if (!($res = ldap_bind($ldap,$dn2,$password)))
{
  print(ldap_error($ldap) . &quot;&lt;br&gt;&quot;);
  die(&quot;Could not bind to $dn&quot;);
}
else
{
  // set search critia for OU
  $filter = &quot;samaccountname=&quot;.$_POST['username'];
  // search OU
  $sr = ldap_search($ldap,$searchdc,$filter);
  if (!$sr)
  {
    die(&quot;search failed\n&quot;);
  }
  else
  {
    // get fields from search
    $info = ldap_get_entries($ldap,$sr);
    if ($info[&quot;count&quot;] == 0)
    {
      $auth = false;
    }
    else
    {
      $auth = true;
      $user_cn = $info[0][&quot;cn&quot;][0];
    }
    // disconnect from LDAP server
    ldap_unbind($ldap);
  }
}
if ($auth == false)
{
  die(&quot;Could not authenticate you to the Active Directory Server.&quot;);
}

$ldap = ldap_connect(&quot;172.17.1.11&quot;) or die(&quot;Cannot connect to AD server :/&quot;);
$oudc = &quot;cn=users, dc=thompsonhealth, dc=org&quot;;
$dn2 = &quot;cn=&quot;.$user_cn.&quot;, &quot;.$oudc;
$password = $_POST['password'];

//look up OU
if (!($res = ldap_bind($ldap,$dn2,$password)))
{
  $login = 0;
  $message = &quot;Invalid Active Directory Password.&quot;;
}
else
{
  $sr = ldap_search($ldap,&quot;dc=thompsonhealth, dc=org&quot;,&quot;cn=&quot;.$user_cn);
  $info = ldap_get_entries($ldap,$sr);
  $login = 1;
  $message = &quot;You have successfully logged in to Active Directory.&lt;br&gt;
        &lt;ul&gt;
          &lt;li&gt;Email : &quot;.$info[0]['mail'][0].&quot;&lt;/li&gt;
                &lt;li&gt;Phone Number : &quot;.$info[0]['telephonenumber'][0].&quot;&lt;/li&gt;
        &lt;/ul&gt;&quot;;
}



&gt;<i> *Repost from DEV List*
</I>&gt;<i>
</I>&gt;<i> Have any of you attempted to authenticate a user against AD using LDAP? I
</I>&gt;<i> am
</I>&gt;<i> developing an application for a school district that will allow teachers
</I>&gt;<i> and
</I>&gt;<i> students to use their existing usernames and passwords. However, we have a
</I>&gt;<i> user table in MySQL to authenticate parents.
</I>&gt;<i>
</I>&gt;<i> Basically what I want to happen is when a user supplies a un/pw
</I>&gt;<i> combination,
</I>&gt;<i> it will first attempt to authenticate against AD and then failover to
</I>&gt;<i> MySQL.
</I>&gt;<i> It may actually be easier to have them choose what type of user they are,
</I>&gt;<i> but I wouldn't get to experience the joy of my original idea!
</I>&gt;<i>
</I>&gt;<i> I am using a class that was developed for LDAP. I have worked on porting
</I>&gt;<i> most of the code to work with the nuances of AD. Before I get much
</I>&gt;<i> further,
</I>&gt;<i> I would like to know if anyone has found a VERY clean and efficient way of
</I>&gt;<i> doing it.
</I>&gt;<i>
</I>&gt;<i> Here is the setup that I am &quot;working&quot; with:
</I>&gt;<i>
</I>&gt;<i> MS Windows Server 2003
</I>&gt;<i> IIS 6 w/ PHP 4.3.4
</I>&gt;<i> Active Directory
</I>&gt;<i> MySQL 4.0.16
</I>&gt;<i>
</I>&gt;<i> I have complete access to the box(es) to install any modules, etc. that
</I>&gt;<i> may
</I>&gt;<i> (or may not) be needed.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> Ty R. Mote
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> talk mailing list
</I>&gt;<i> <A HREF="http://lists.nyphp.org/mailman/listinfo/talk">talk at lists.nyphp.org</A>
</I>&gt;<i> <A HREF="http://lists.nyphp.org/mailman/listinfo/talk">http://lists.nyphp.org/mailman/listinfo/talk</A>
</I>&gt;<i>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008058.html">[nycphp-talk] *Repost from DEV List* LDAP Authentication Against	Microshaft's Active Directory
</A></li>
	<LI>Next message: <A HREF="008064.html">[nycphp-talk] *Repost from DEV List* LDAP Authentication	AgainstMicroshaft's Active Directory
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8062">[ date ]</a>
              <a href="thread.html#8062">[ thread ]</a>
              <a href="subject.html#8062">[ subject ]</a>
              <a href="author.html#8062">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.nyphp.org/mailman/listinfo/talk">More information about the talk
mailing list</a><br>
</body></html>
