<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-51353372-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-51353372-3');
</script>
   <TITLE> [nycphp-talk] memory problems
   </TITLE>
   <LINK REL="Index" HREF="http://nyphp.org/pipermail/talk/2009-June/index.html" >
   <LINK REL="made" HREF="mailto:talk%40lists.nyphp.org?Subject=Re:%20Re%3A%20%5Bnyphp-talk%5D%20memory%20problems&In-Reply-To=%3C20A4C52A-7497-4E3D-80FE-4226CA21056F%40beaffinitive.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028221.html">
   <LINK REL="Next"  HREF="028224.html">
 <meta name="description" content="PHP jobs stackware web application support and development forums for Mongo LAMP MySQL SQL Windows IIS Linux." />
<meta name="author" content="Stackware Web Development - http://stackware.com" />
<meta name="verify-v1" content="zWMoPwMn/dolscLkjLXTpRqgr9K8bzlzL1vM9WTjpHc=" />
<meta name="msvalidate.01" content="F85F81C1D0BAB5C349E8395628845E27" />
<meta name="y_key" content="265502be3db4fb6e" />
</HEAD>
         <BODY BGCOLOR="#ffffff">
<h1 style="float: right; margin: 0; padding: 0 0 0 15px;"><a href="https://www.meetup.com/new-york-php/">NYCPHP Meetup</a></h1><h1><a href="http://www.nyphp.org">NYPHP.org</a></h1>
   <H1>[nycphp-talk] memory problems</H1>
    <B>Rob Marscher</B> 
    <A HREF="mailto:talk%40lists.nyphp.org?Subject=Re:%20Re%3A%20%5Bnyphp-talk%5D%20memory%20problems&In-Reply-To=%3C20A4C52A-7497-4E3D-80FE-4226CA21056F%40beaffinitive.com%3E"
       TITLE="[nycphp-talk] memory problems">rmarscher at beaffinitive.com
       </A><BR>
    <I>Thu Jun  4 12:25:45 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="028221.html">[nycphp-talk] memory problems
</A></li>
        <LI>Next message: <A HREF="028224.html">[nycphp-talk] memory problems
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28222">[ date ]</a>
              <a href="thread.html#28222">[ thread ]</a>
              <a href="subject.html#28222">[ subject ]</a>
              <a href="author.html#28222">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Sorry guys.  iPhone prematurely sent that.

The other idea is to buffer the download of the file. You can use  
fopen/fread/fclose to make sure you only keep say 1mb of data in php's  
memory while you download the file.  Usually urls can be treated like  
files via php's url file wrappers unless those have been disabled.

Or you can just
ini_set('memory_limit', '1500m');
Or however much memory you have available for the script and see if  
you can get by.

Really though, there's no reason a script like this needs to use so  
much memory.

Sometimes when running batch scripts, i've seen memory usage continue  
to rise through the iterations for unknown reasons. In that case, I  
split the script so there's a master script that manages the queue and  
another script that I exec to run the operation. That way it's a  
separate process and memory is always cleaned up.

Good luck,
Rob


On Jun 4, 2009, at 11:12 AM, Rob Marscher &lt;<A HREF="http://lists.nyphp.org/mailman/listinfo/talk">rmarscher at beaffinitive.com</A>&gt;  
wrote:

&gt;<i> GD needs to operate on raw data so even if the jpegs are smaller  
</I>&gt;<i> than your 500mb limit, when it expands it, it will go over.
</I>&gt;<i>
</I>&gt;<i> A couple ideas... exec ImageMagick convert instead of using GD for  
</I>&gt;<i> the resize.
</I>&gt;<i>
</I>&gt;<i> On Jun 4, 2009, at 10:48 AM, Rahmin Pavlovic &lt;<A HREF="http://lists.nyphp.org/mailman/listinfo/talk">rahmin at insite-out.com</A>&gt;  
</I>&gt;<i> wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Heya,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> So, I have this script that does the following:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1.  Requests jpeg from origin CDN via cURL
</I>&gt;&gt;<i> 2.  If file doesnt exist... log error, continue.
</I>&gt;&gt;<i> 3.  Write jpeg to temp file
</I>&gt;&gt;<i> 4.  Resize original image (GD lib) to temp file. FTP to directory  
</I>&gt;&gt;<i> on new CDN.  Create directory structure if not present.  Repeat  
</I>&gt;&gt;<i> seven times per image.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Not sure how many, but we're talking about 10k; maybe 15k images.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The script works, but problem we're running into is the memory  
</I>&gt;&gt;<i> limit.  We got about 31% through the images, and hit:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> PHP Fatal error: Allowed memory size of 524288000 bytes exhausted  
</I>&gt;&gt;<i> (tried to allocate 41760 bytes) in /web/lib/php/populate_images.php  
</I>&gt;&gt;<i> on line 135
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Maybe it's me, but if we have to allot more than 500 MB of memory,  
</I>&gt;&gt;<i> something is wrong.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Any ideas?  Maybe sleep the script after each image?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> We're running the script in shell.
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> New York PHP User Group Community Talk Mailing List
</I>&gt;&gt;<i> <A HREF="http://lists.nyphp.org/mailman/listinfo/talk">http://lists.nyphp.org/mailman/listinfo/talk</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> <A HREF="http://www.nyphp.org/show_participation.php">http://www.nyphp.org/show_participation.php</A>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028221.html">[nycphp-talk] memory problems
</A></li>
	<LI>Next message: <A HREF="028224.html">[nycphp-talk] memory problems
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28222">[ date ]</a>
              <a href="thread.html#28222">[ thread ]</a>
              <a href="subject.html#28222">[ subject ]</a>
              <a href="author.html#28222">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.nyphp.org/mailman/listinfo/talk">More information about the talk
mailing list</a><br>
</body></html>
