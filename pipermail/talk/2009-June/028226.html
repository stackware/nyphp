<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-51353372-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-51353372-3');
</script>
   <TITLE> [nycphp-talk] memory problems
   </TITLE>
   <LINK REL="Index" HREF="http://nyphp.org/pipermail/talk/2009-June/index.html" >
   <LINK REL="made" HREF="mailto:talk%40lists.nyphp.org?Subject=Re:%20Re%3A%20%5Bnyphp-talk%5D%20memory%20problems&In-Reply-To=%3C8CBB34A0230E395-6F0-832%40FWM-M13.sysops.aol.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="028223.html">
   <LINK REL="Next"  HREF="028234.html">
 <meta name="description" content="PHP jobs stackware web application support and development forums for Mongo LAMP MySQL SQL Windows IIS Linux." />
<meta name="author" content="Stackware Web Development - http://stackware.com" />
<meta name="verify-v1" content="zWMoPwMn/dolscLkjLXTpRqgr9K8bzlzL1vM9WTjpHc=" />
<meta name="msvalidate.01" content="F85F81C1D0BAB5C349E8395628845E27" />
<meta name="y_key" content="265502be3db4fb6e" />
</HEAD>
         <BODY BGCOLOR="#ffffff">
<h1 style="float: right; margin: 0; padding: 0 0 0 15px;"><a href="https://www.meetup.com/new-york-php/">NYCPHP Meetup</a></h1><h1><a href="http://www.nyphp.org">NYPHP.org</a></h1>
   <H1>[nycphp-talk] memory problems</H1>
    <B>y2rob at aol.com</B> 
    <A HREF="mailto:talk%40lists.nyphp.org?Subject=Re:%20Re%3A%20%5Bnyphp-talk%5D%20memory%20problems&In-Reply-To=%3C8CBB34A0230E395-6F0-832%40FWM-M13.sysops.aol.com%3E"
       TITLE="[nycphp-talk] memory problems">y2rob at aol.com
       </A><BR>
    <I>Thu Jun  4 12:38:22 EDT 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="028223.html">[nycphp-talk] memory problems
</A></li>
        <LI>Next message: <A HREF="028234.html">[nycphp-talk] memory problems
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28226">[ date ]</a>
              <a href="thread.html#28226">[ thread ]</a>
              <a href="subject.html#28226">[ subject ]</a>
              <a href="author.html#28226">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
 wow, awesome brent, i like the forking idea.

question:
how are you getting $files2process.? i'm assuming you're reading a directory if it were local, but can you get this number remotely from cURL?

thanks
~rob


 


 

-----Original Message-----
From: Brent Baisley &lt;<A HREF="http://lists.nyphp.org/mailman/listinfo/talk">brenttech at gmail.com</A>&gt;
To: NYPHP Talk &lt;<A HREF="http://lists.nyphp.org/mailman/listinfo/talk">talk at lists.nyphp.org</A>&gt;
Sent: Thu, 4 Jun 2009 12:29 pm
Subject: Re: [nycphp-talk] memory problems










You are not releasing memory somewhere. Using sleep is not going to
help in clearing memory. Monitor your memory usage (memory_get_usage)
and see if your memory usage keeps climbing or if it's just 1 big
image that is causing the problem.

Alternatively, fork your script for each image if you are running it
from the command line, and on unix.

$maxForks = 20;
while ( $files2process ) {

$processFile = getNextFileURL();
for ( $i=0; $i&lt;$maxForks; $i++ ) {

$pid = pcntl_fork();
if ($pid == -1) {
  die('could not fork');
} else if ($pid) {
  // we are the parent
  $childPIDs[]  = $pid;
} else {
  ...process file...
 exit();
}

// Wait for all the children to finish
foreach($childPIDs as $pid) {
    pcntl_waitpid($pid, $status);
    echo '*** '.$pid. &quot; ENDED\n&quot;;
}

}

Then a single image won't stop the whole process, the one image will
just cause one child process to exit. This would also speed things up
considerably since you can process multiple images at once. There are
obviously holes in the script, but they should be easy to fill.

Be aware that the system you are on may not have forking enabled. In
which case, forget my whole response.

Brent Baisley


On Thu, Jun 4, 2009 at 12:00 PM, Donald J. Organ IV
&lt;<A HREF="http://lists.nyphp.org/mailman/listinfo/talk">dorgan at donaldorgan.com</A>&gt; wrote:
&gt;<i> Do you mind sharing the script?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ----- Original Message -----
</I>&gt;<i> From: &quot;Rahmin Pavlovic&quot; &lt;<A HREF="http://lists.nyphp.org/mailman/listinfo/talk">rahmin at insite-out.com</A>&gt;
</I>&gt;<i> To: &quot;NYPHP Talk&quot; &lt;<A HREF="http://lists.nyphp.org/mailman/listinfo/talk">talk at lists.nyphp.org</A>&gt;
</I>&gt;<i> Sent: Thursday, June 4, 2009 11:48:40 AM
</I>&gt;<i> Subject: [nycphp-talk] memory problems
</I>&gt;<i>
</I>&gt;<i> Heya,
</I>&gt;<i>
</I>&gt;<i> So, I have this script that does the following:
</I>&gt;<i>
</I>&gt;<i> 1. ?Requests jpeg from origin CDN via cURL
</I>&gt;<i> 2. ?If file doesnt exist... log error, continue.
</I>&gt;<i> 3. ?Write jpeg to temp file
</I>&gt;<i> 4. ?Resize original image (GD lib) to temp file. FTP to directory on
</I>&gt;<i> new CDN. ?Create directory structure if not present. ?Repeat seven
</I>&gt;<i> times per image.
</I>&gt;<i>
</I>&gt;<i> Not sure how many, but we're talking about 10k; maybe 15k images.
</I>&gt;<i>
</I>&gt;<i> The script works, but problem we're running into is the memory limit.
</I>&gt;<i> We got about 31% through the images, and hit:
</I>&gt;<i>
</I>&gt;<i> PHP Fatal error: Allowed memory size of 524288000 bytes exhausted
</I>&gt;<i> (tried to allocate 41760 bytes) in /web/lib/php/populate_images.php on
</I>&gt;<i> line 135
</I>&gt;<i>
</I>&gt;<i> Maybe it's me, but if we have to allot more than 500 MB of memory,
</I>&gt;<i> something is wrong.
</I>&gt;<i>
</I>&gt;<i> Any ideas? ?Maybe sleep the script after each image?
</I>&gt;<i>
</I>&gt;<i> We're running the script in shell.
</I>&gt;<i> _______________________________________________
</I>&gt;<i> New York PHP User Group Community Talk Mailing List
</I>&gt;<i> <A HREF="http://lists.nyphp.org/mailman/listinfo/talk">http://lists.nyphp.org/mailman/listinfo/talk</A>
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://www.nyphp.org/show_participation.php">http://www.nyphp.org/show_participation.php</A>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> New York PHP User Group Community Talk Mailing List
</I>&gt;<i> <A HREF="http://lists.nyphp.org/mailman/listinfo/talk">http://lists.nyphp.org/mailman/listinfo/talk</A>
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://www.nyphp.org/show_participation.php">http://www.nyphp.org/show_participation.php</A>
</I>&gt;<i>
</I>_______________________________________________
New York PHP User Group Community Talk Mailing List
<A HREF="http://lists.nyphp.org/mailman/listinfo/talk">http://lists.nyphp.org/mailman/listinfo/talk</A>

<A HREF="http://www.nyphp.org/show_participation.php">http://www.nyphp.org/show_participation.php</A>



 

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.nyphp.org/pipermail/talk/attachments/20090604/fca1b391/attachment.html">http://lists.nyphp.org/pipermail/talk/attachments/20090604/fca1b391/attachment.html</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="028223.html">[nycphp-talk] memory problems
</A></li>
	<LI>Next message: <A HREF="028234.html">[nycphp-talk] memory problems
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#28226">[ date ]</a>
              <a href="thread.html#28226">[ thread ]</a>
              <a href="subject.html#28226">[ subject ]</a>
              <a href="author.html#28226">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.nyphp.org/mailman/listinfo/talk">More information about the talk
mailing list</a><br>
</body></html>
