<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-51353372-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-51353372-3');
</script>
   <TITLE> [nycphp-talk] Session Handling
   </TITLE>
   <LINK REL="Index" HREF="http://nyphp.org/pipermail/talk/2005-August/index.html" >
   <LINK REL="made" HREF="mailto:talk%40lists.nyphp.org?Subject=Re:%20Re%3A%20%5Bnyphp-talk%5D%20Session%20Handling&In-Reply-To=%3C42EE2B37.90606%40simmons.edu%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015421.html">
   <LINK REL="Next"  HREF="015423.html">
 <meta name="description" content="PHP jobs stackware web application support and development forums for Mongo LAMP MySQL SQL Windows IIS Linux." />
<meta name="author" content="Stackware Web Development - http://stackware.com" />
<meta name="verify-v1" content="zWMoPwMn/dolscLkjLXTpRqgr9K8bzlzL1vM9WTjpHc=" />
<meta name="msvalidate.01" content="F85F81C1D0BAB5C349E8395628845E27" />
<meta name="y_key" content="265502be3db4fb6e" />
</HEAD>
         <BODY BGCOLOR="#ffffff">
<h1 style="float: right; margin: 0; padding: 0 0 0 15px;"><a href="https://www.meetup.com/new-york-php/">NYCPHP Meetup</a></h1><h1><a href="http://www.nyphp.org">NYPHP.org</a></h1>
   <H1>[nycphp-talk] Session Handling</H1>
    <B>Jonathan</B> 
    <A HREF="mailto:talk%40lists.nyphp.org?Subject=Re:%20Re%3A%20%5Bnyphp-talk%5D%20Session%20Handling&In-Reply-To=%3C42EE2B37.90606%40simmons.edu%3E"
       TITLE="[nycphp-talk] Session Handling">hendler at simmons.edu
       </A><BR>
    <I>Mon Aug  1 10:01:27 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="015421.html">[nycphp-talk] Session Handling
</A></li>
        <LI>Next message: <A HREF="015423.html">[nycphp-talk] Sssllloooowww Query
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15422">[ date ]</a>
              <a href="thread.html#15422">[ thread ]</a>
              <a href="subject.html#15422">[ subject ]</a>
              <a href="author.html#15422">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I've had similar questions regarding IP security.
We didn't use IP addresses to uniquely identify users because they were 
redundant.
We tried to hash browser agents and other items client items to identify 
users.
Here is the belief that I would also like to know a definitive answer to 
that made us not use IP addresses:
corporate networks, some schools, AOL, and other groups behind a 
gateway/router are all going to appear to be the same IP.
There was a &quot;forwarded&quot; ip that could append an internal IP with the 
gateway IP or something to that affect, but I haven't implemented 
anything like that and would like to know if it is practical.

We require cookies and SSL and that seems to do the trick for most 
secure apps.

Joseph Crawford wrote:

&gt;<i> Hello Everyone,
</I>&gt;<i>
</I>&gt;<i> I have implemented my session handling to take place in the database 
</I>&gt;<i> rather than flat files on the system.  No i have a question.  I read 
</I>&gt;<i> somewhere that it is always good to check the IP of the user to make 
</I>&gt;<i> sure the session has not been hijacked.  Would the following be secure 
</I>&gt;<i> enough for that?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &lt;?php
</I>&gt;<i>
</I>&gt;<i> class session
</I>&gt;<i> {
</I>&gt;<i>     /* Define the mysql table you wish to use with
</I>&gt;<i>     this class, this table MUST exist. */
</I>&gt;<i>     private $table = &quot;sessions&quot;;
</I>&gt;<i>     private $_db;
</I>&gt;<i>     private $_page;
</I>&gt;<i>     private $_sess_id;
</I>&gt;<i>     private $_ip;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>     public function __construct(Database $db) {
</I>&gt;<i>         $this-&gt;_db = $db;
</I>&gt;<i>     }
</I>&gt;<i>
</I>&gt;<i>     public function init() {
</I>&gt;<i>         $this-&gt;_sess_id = session_id();
</I>&gt;<i>         $this-&gt;_page = $_SERVER['REQUEST_URI'];
</I>&gt;<i>         $this-&gt;_ip = $_SERVER['REMOTE_ADDR'];
</I>&gt;<i>        
</I>&gt;<i>         $this-&gt;CheckIP();
</I>&gt;<i>     }
</I>&gt;<i>
</I>&gt;<i>     public function open($path, $name) {
</I>&gt;<i>
</I>&gt;<i>         return TRUE;
</I>&gt;<i>     }
</I>&gt;<i>
</I>&gt;<i>     /* Close session */
</I>&gt;<i>     public function close() {
</I>&gt;<i>         /* This is used for a manual call of the
</I>&gt;<i>         session gc function */
</I>&gt;<i>         $this-&gt;gc(0);
</I>&gt;<i>         return TRUE;
</I>&gt;<i>     }
</I>&gt;<i>
</I>&gt;<i>     /* Read session data from database */
</I>&gt;<i>     public function read($ses_id) {
</I>&gt;<i>
</I>&gt;<i>         $session_sql = &quot;SELECT * FROM &quot; . $this-&gt;table
</I>&gt;<i>         . &quot; WHERE ses_id = '$ses_id'&quot;;
</I>&gt;<i>         $session_res = $this-&gt;_db-&gt;Query($session_sql);
</I>&gt;<i>         if (!$session_res) {
</I>&gt;<i>             return '';
</I>&gt;<i>         }
</I>&gt;<i>
</I>&gt;<i>         $session_num = $this-&gt;_db-&gt;NumRows($session_res);
</I>&gt;<i>         if ($session_num &gt; 0) {
</I>&gt;<i>             $session_row = $this-&gt;_db-&gt;FetchArray($session_res);
</I>&gt;<i>             $ses_data = $session_row[&quot;ses_value&quot;];
</I>&gt;<i>             return $ses_data;
</I>&gt;<i>         } else {
</I>&gt;<i>             return '';
</I>&gt;<i>         }
</I>&gt;<i>     }
</I>&gt;<i>
</I>&gt;<i>     /* Write new data to database */
</I>&gt;<i>     public function write($ses_id, $data) {
</I>&gt;<i>
</I>&gt;<i>         $this-&gt;init();
</I>&gt;<i>
</I>&gt;<i>         $session_sql = &quot;UPDATE &quot; . $this-&gt;table
</I>&gt;<i>         . &quot; SET ses_time='&quot; . time()
</I>&gt;<i>         . &quot;', page='&quot;.$this-&gt;_page
</I>&gt;<i>         . &quot;', ses_value='$data' WHERE ses_id='$ses_id'&quot;;
</I>&gt;<i>         $session_res = $this-&gt;_db-&gt;Query($session_sql);
</I>&gt;<i>         if (!$session_res) return FALSE;
</I>&gt;<i>
</I>&gt;<i>         if($this-&gt;_db-&gt;AffectedRows()) return TRUE;
</I>&gt;<i>
</I>&gt;<i>         $session_sql = &quot;INSERT INTO &quot; . $this-&gt;table
</I>&gt;<i>         . &quot; (ses_id, ses_time, ses_start, page, ip, ses_value)&quot;
</I>&gt;<i>         . &quot; VALUES ('$ses_id', '&quot; . time()
</I>&gt;<i>         . &quot;', '&quot; . time() . &quot;', '$this-&gt;_page', '$this-&gt;_ip', '$data')&quot;;
</I>&gt;<i>         $session_res = $this-&gt;_db-&gt;Query($session_sql);
</I>&gt;<i>         if (!$session_res) return FALSE;
</I>&gt;<i>         else return TRUE;
</I>&gt;<i>     }
</I>&gt;<i>
</I>&gt;<i>     /* Destroy session record in database */
</I>&gt;<i>     public function destroy($ses_id) {
</I>&gt;<i>         $session_sql = &quot;DELETE FROM &quot; . $this-&gt;table
</I>&gt;<i>         . &quot; WHERE ses_id = '$ses_id'&quot;;
</I>&gt;<i>         $session_res = $this-&gt;_db-&gt;Query($session_sql);
</I>&gt;<i>         if (!$session_res) return FALSE;
</I>&gt;<i>         else return TRUE;
</I>&gt;<i>     }
</I>&gt;<i>
</I>&gt;<i>     /* Garbage collection, deletes old sessions */
</I>&gt;<i>     public function gc($life) {
</I>&gt;<i>         $ses_life = strtotime(&quot;-5 minutes&quot;);
</I>&gt;<i>
</I>&gt;<i>         $session_sql = &quot;DELETE FROM &quot; . $this-&gt;table
</I>&gt;<i>         . &quot; WHERE ses_time &lt; $ses_life&quot;;
</I>&gt;<i>         $session_res = $this-&gt;_db-&gt;Query($session_sql);
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>         if (!$session_res) return FALSE;
</I>&gt;<i>         else return TRUE;
</I>&gt;<i>     }
</I>&gt;<i>
</I>&gt;<i>     private function UpdatePage() {
</I>&gt;<i>         $session_sql = &quot;UPDATE &quot;.$this-&gt;table.&quot; SET 
</I>&gt;<i> page='&quot;.mysql_real_escape_string($this-&gt;_page).&quot;' WHERE 
</I>&gt;<i> ses_id='&quot;.$this-&gt;_sess_id.&quot;'&quot;;
</I>&gt;<i>         $this-&gt;_db-&gt;Query($session_sql);
</I>&gt;<i>     }
</I>&gt;<i>
</I>&gt;<i>     private function CheckIP() {
</I>&gt;<i>         $intIP = explode('.', $this-&gt;_ip);
</I>&gt;<i>         $curIP = explode('.', $_SERVER['REMOTE_ADDR']);
</I>&gt;<i>         if( !strcmp($intIP, $curIP) ) {
</I>&gt;<i>             $sess_sql = &quot;DELETE FROM &quot;.$this-&gt;table.&quot; WHERE 
</I>&gt;<i> ses_id='&quot;.$this-&gt;_sess_id.&quot;'&quot;;
</I>&gt;<i>             $this-&gt;_db-&gt;Query($sess_sql);
</I>&gt;<i>             session_destroy();
</I>&gt;<i>         }
</I>&gt;<i>     }
</I>&gt;<i> }
</I>&gt;<i> ?&gt;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Is this a good enough check for the IP?  If the IP check fails it 
</I>&gt;<i> should remove the session from the database, but also it calls 
</I>&gt;<i> session_destroy  Why did i do it this way rather than just calling 
</I>&gt;<i> $this-&gt;destroy() or just using session_destroy?  I noticed that it was 
</I>&gt;<i> not actually removing the session from the database if i did not 
</I>&gt;<i> actuall make the database query myself.  Any criticism would be 
</I>&gt;<i> appreciated as this is my first attempt at storing sessions in the 
</I>&gt;<i> database (with the help of a zend tutorial)
</I>&gt;<i> -- 
</I>&gt;<i> Joseph Crawford Jr.
</I>&gt;<i> Codebowl Solutions, Inc.
</I>&gt;<i> 1-802-671-2021
</I>&gt;<i> <A HREF="http://lists.nyphp.org/mailman/listinfo/talk">codebowl at gmail.com</A> &lt;mailto:<A HREF="http://lists.nyphp.org/mailman/listinfo/talk">codebowl at gmail.com</A>&gt;
</I>&gt;<i>
</I>&gt;<i>------------------------------------------------------------------------
</I>&gt;<i>
</I>&gt;<i>_______________________________________________
</I>&gt;<i>New York PHP Talk Mailing List
</I>&gt;<i>AMP Technology
</I>&gt;<i>Supporting Apache, MySQL and PHP
</I>&gt;<i><A HREF="http://lists.nyphp.org/mailman/listinfo/talk">http://lists.nyphp.org/mailman/listinfo/talk</A>
</I>&gt;<i><A HREF="http://www.nyphp.org">http://www.nyphp.org</A>
</I>&gt;<i>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015421.html">[nycphp-talk] Session Handling
</A></li>
	<LI>Next message: <A HREF="015423.html">[nycphp-talk] Sssllloooowww Query
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15422">[ date ]</a>
              <a href="thread.html#15422">[ thread ]</a>
              <a href="subject.html#15422">[ subject ]</a>
              <a href="author.html#15422">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.nyphp.org/mailman/listinfo/talk">More information about the talk
mailing list</a><br>
</body></html>
