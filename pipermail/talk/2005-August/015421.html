<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
 <HEAD>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-51353372-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-51353372-3');
</script>
   <TITLE> [nycphp-talk] Session Handling
   </TITLE>
   <LINK REL="Index" HREF="http://nyphp.org/pipermail/talk/2005-August/index.html" >
   <LINK REL="made" HREF="mailto:talk%40lists.nyphp.org?Subject=Re:%20Re%3A%20%5Bnyphp-talk%5D%20Session%20Handling&In-Reply-To=%3C8d9a4280050801064770c117%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="015420.html">
   <LINK REL="Next"  HREF="015422.html">
 <meta name="description" content="PHP jobs stackware web application support and development forums for Mongo LAMP MySQL SQL Windows IIS Linux." />
<meta name="author" content="Stackware Web Development - http://stackware.com" />
<meta name="verify-v1" content="zWMoPwMn/dolscLkjLXTpRqgr9K8bzlzL1vM9WTjpHc=" />
<meta name="msvalidate.01" content="F85F81C1D0BAB5C349E8395628845E27" />
<meta name="y_key" content="265502be3db4fb6e" />
</HEAD>
         <BODY BGCOLOR="#ffffff">
<h1 style="float: right; margin: 0; padding: 0 0 0 15px;"><a href="https://www.meetup.com/new-york-php/">NYCPHP Meetup</a></h1><h1><a href="http://www.nyphp.org">NYPHP.org</a></h1>
   <H1>[nycphp-talk] Session Handling</H1>
    <B>Joseph Crawford</B> 
    <A HREF="mailto:talk%40lists.nyphp.org?Subject=Re:%20Re%3A%20%5Bnyphp-talk%5D%20Session%20Handling&In-Reply-To=%3C8d9a4280050801064770c117%40mail.gmail.com%3E"
       TITLE="[nycphp-talk] Session Handling">codebowl at gmail.com
       </A><BR>
    <I>Mon Aug  1 09:47:45 EDT 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="015420.html">[nycphp-talk] OT Eclipse
</A></li>
        <LI>Next message: <A HREF="015422.html">[nycphp-talk] Session Handling
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15421">[ date ]</a>
              <a href="thread.html#15421">[ thread ]</a>
              <a href="subject.html#15421">[ subject ]</a>
              <a href="author.html#15421">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello Everyone,

I have implemented my session handling to take place in the database rather 
than flat files on the system. No i have a question. I read somewhere that 
it is always good to check the IP of the user to make sure the session has 
not been hijacked. Would the following be secure enough for that?


&lt;?php

class session
{
/* Define the mysql table you wish to use with
this class, this table MUST exist. */
private $table = &quot;sessions&quot;;
private $_db;
private $_page;
private $_sess_id;
private $_ip;


public function __construct(Database $db) {
$this-&gt;_db = $db;
}

public function init() {
$this-&gt;_sess_id = session_id();
$this-&gt;_page = $_SERVER['REQUEST_URI'];
$this-&gt;_ip = $_SERVER['REMOTE_ADDR'];

$this-&gt;CheckIP();
}

public function open($path, $name) {

return TRUE;
}

/* Close session */
public function close() {
/* This is used for a manual call of the
session gc function */
$this-&gt;gc(0);
return TRUE;
}

/* Read session data from database */
public function read($ses_id) {

$session_sql = &quot;SELECT * FROM &quot; . $this-&gt;table
. &quot; WHERE ses_id = '$ses_id'&quot;;
$session_res = $this-&gt;_db-&gt;Query($session_sql);
if (!$session_res) {
return '';
}

$session_num = $this-&gt;_db-&gt;NumRows($session_res);
if ($session_num &gt; 0) {
$session_row = $this-&gt;_db-&gt;FetchArray($session_res);
$ses_data = $session_row[&quot;ses_value&quot;];
return $ses_data;
} else {
return '';
}
}

/* Write new data to database */
public function write($ses_id, $data) {

$this-&gt;init();

$session_sql = &quot;UPDATE &quot; . $this-&gt;table
. &quot; SET ses_time='&quot; . time()
. &quot;', page='&quot;.$this-&gt;_page
. &quot;', ses_value='$data' WHERE ses_id='$ses_id'&quot;;
$session_res = $this-&gt;_db-&gt;Query($session_sql);
if (!$session_res) return FALSE;

if($this-&gt;_db-&gt;AffectedRows()) return TRUE;

$session_sql = &quot;INSERT INTO &quot; . $this-&gt;table
. &quot; (ses_id, ses_time, ses_start, page, ip, ses_value)&quot;
. &quot; VALUES ('$ses_id', '&quot; . time()
. &quot;', '&quot; . time() . &quot;', '$this-&gt;_page', '$this-&gt;_ip', '$data')&quot;;
$session_res = $this-&gt;_db-&gt;Query($session_sql);
if (!$session_res) return FALSE;
else return TRUE;
}

/* Destroy session record in database */
public function destroy($ses_id) {
$session_sql = &quot;DELETE FROM &quot; . $this-&gt;table
. &quot; WHERE ses_id = '$ses_id'&quot;;
$session_res = $this-&gt;_db-&gt;Query($session_sql);
if (!$session_res) return FALSE;
else return TRUE;
}

/* Garbage collection, deletes old sessions */
public function gc($life) {
$ses_life = strtotime(&quot;-5 minutes&quot;);

$session_sql = &quot;DELETE FROM &quot; . $this-&gt;table
. &quot; WHERE ses_time &lt; $ses_life&quot;;
$session_res = $this-&gt;_db-&gt;Query($session_sql);


if (!$session_res) return FALSE;
else return TRUE;
}

private function UpdatePage() {
$session_sql = &quot;UPDATE &quot;.$this-&gt;table.&quot; SET 
page='&quot;.mysql_real_escape_string($this-&gt;_page).&quot;' WHERE 
ses_id='&quot;.$this-&gt;_sess_id.&quot;'&quot;;
$this-&gt;_db-&gt;Query($session_sql);
}

 private function CheckIP() {
$intIP = explode('.', $this-&gt;_ip);
$curIP = explode('.', $_SERVER['REMOTE_ADDR']);
if( !strcmp($intIP, $curIP) ) {
$sess_sql = &quot;DELETE FROM &quot;.$this-&gt;table.&quot; WHERE 
ses_id='&quot;.$this-&gt;_sess_id.&quot;'&quot;;
$this-&gt;_db-&gt;Query($sess_sql);
session_destroy();
}
}
}
?&gt;


Is this a good enough check for the IP? If the IP check fails it should 
remove the session from the database, but also it calls session_destroy Why 
did i do it this way rather than just calling $this-&gt;destroy() or just using 
session_destroy? I noticed that it was not actually removing the session 
from the database if i did not actuall make the database query myself. Any 
criticism would be appreciated as this is my first attempt at storing 
sessions in the database (with the help of a zend tutorial)
-- 
Joseph Crawford Jr.
Codebowl Solutions, Inc.
1-802-671-2021
<A HREF="http://lists.nyphp.org/mailman/listinfo/talk">codebowl at gmail.com</A>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.nyphp.org/pipermail/talk/attachments/20050801/e4ee8e44/attachment.html">http://lists.nyphp.org/pipermail/talk/attachments/20050801/e4ee8e44/attachment.html</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="015420.html">[nycphp-talk] OT Eclipse
</A></li>
	<LI>Next message: <A HREF="015422.html">[nycphp-talk] Session Handling
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#15421">[ date ]</a>
              <a href="thread.html#15421">[ thread ]</a>
              <a href="subject.html#15421">[ subject ]</a>
              <a href="author.html#15421">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="http://lists.nyphp.org/mailman/listinfo/talk">More information about the talk
mailing list</a><br>
</body></html>
